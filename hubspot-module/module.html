<!-- Will's Bleach Calculator - Custom HubSpot Module -->
<div class="wf-calculator-module">
  <div id="wf-calc-container">
    <iframe
      id="wf-calc-iframe"
      src="https://willsbleachcalculator.netlify.app/"
      title="Will's Bleach Calculator"
      frameborder="0"
      scrolling="no">
    </iframe>
  </div>
</div>

<script>
// Enhanced postMessage handler with anti-loop protection
let lastHeight = 0;
let resizeTimeout;

window.addEventListener('message', function(event) {
  if (event.data && event.data.type === 'calculator-resize') {
    const iframe = document.getElementById('wf-calc-iframe');
    const container = document.getElementById('wf-calc-container');

    if (iframe && event.data.height) {
      const requestedHeight = event.data.height;
      const currentHeight = parseInt(iframe.style.height) || 400;

      // ANTI-LOOP PROTECTION: Only resize if change is significant
      const heightDifference = Math.abs(requestedHeight - currentHeight);
      if (heightDifference < 10) {
        console.log('üìê Custom Module: Height change too small, skipping resize');
        return;
      }

      // Enhanced logging to show direction of change
      const direction = requestedHeight > currentHeight ? 'expanding' : 'shrinking';
      console.log('üìê Custom Module: Height change detected (' + direction + ') - Current:', currentHeight + 'px, Requested:', requestedHeight + 'px');

      // Prevent runaway expansion (increased from 3000 to 4500)
      const maxHeight = 4500;
      const newHeight = Math.min(requestedHeight, maxHeight);

      // Debounce rapid updates
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        console.log('üìê Custom Module: Resizing from', currentHeight + 'px to', newHeight + 'px (' + direction + ')');

        // Update iframe height
        iframe.style.height = newHeight + 'px';

        // Update container
        if (container) {
          container.style.height = 'auto';
        }

        // Update module container
        const moduleContainer = iframe.closest('.wf-calculator-module');
        if (moduleContainer) {
          moduleContainer.style.height = 'auto';
        }

        lastHeight = newHeight;
        console.log('üìê Custom Module: Resize complete - iframe now', newHeight + 'px');
      }, 100);
    }
  }
});

// Initialize iframe
document.addEventListener('DOMContentLoaded', function() {
  const iframe = document.getElementById('wf-calc-iframe');
  if (iframe) {
    console.log('üìê Custom Module: Iframe initialized at 400px');

    iframe.onload = function() {
      console.log('üìê Custom Module: Iframe loaded, ready for height messages');
    };
  }
});
</script>